name: Build & Publish Fork Image (Beta)

on:
  push:
    tags:
      # Example: v1.4.3-beta.2-r.1
      - "v*-beta.*-r.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Tag to build (example: v1.4.3-beta.2-r.1). Leave blank when running from a tag push."
        required: false
        default: ""

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve beta version tag
        id: ver
        shell: bash
        run: |
          set -euo pipefail

          VERSION_INPUT="${{ github.event.inputs.version }}"
          REF_NAME="${{ github.ref_name }}"

          if [[ -n "${VERSION_INPUT}" ]]; then
            VERSION="${VERSION_INPUT}"
          else
            VERSION="${REF_NAME}"
          fi

          if [[ -z "${VERSION}" ]]; then
            echo "ERROR: No version resolved. Provide workflow_dispatch input 'version' or run from a tag push."
            exit 1
          fi

          # Enforce beta fork tag shape: vX.Y.Z-beta.K-r.N
          if ! [[ "${VERSION}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-beta\.[0-9]+-r\.[0-9]+$ ]]; then
            echo "ERROR: Version must look like vX.Y.Z-beta.K-r.N (example v1.4.3-beta.2-r.1). Got: ${VERSION}"
            exit 1
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "supervised_version=supervised-${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Resolved VERSION=${VERSION}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Non-supervised beta image:
      # - ghcr.io/<owner>/tracearr:next
      # - ghcr.io/<owner>/tracearr:vX.Y.Z-beta.K-r.N
      - name: Build & push beta image (non-supervised)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/tracearr:next
            ghcr.io/${{ github.repository_owner }}/tracearr:${{ steps.ver.outputs.version }}
          build-args: |
            APP_VERSION=${{ steps.ver.outputs.version }}
            APP_TAG=${{ steps.ver.outputs.version }}
            APP_COMMIT=${{ github.sha }}

      # Supervised beta image:
      # - ghcr.io/<owner>/tracearr:supervised-next
      # - ghcr.io/<owner>/tracearr:supervised-vX.Y.Z-beta.K-r.N
      - name: Build & push beta image (supervised)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.supervised
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/tracearr:supervised-next
            ghcr.io/${{ github.repository_owner }}/tracearr:${{ steps.ver.outputs.supervised_version }}
          build-args: |
            APP_VERSION=${{ steps.ver.outputs.version }}
            APP_TAG=${{ steps.ver.outputs.supervised_version }}
            APP_COMMIT=${{ github.sha }}