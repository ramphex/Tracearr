# Tracearr - All-in-One Deployment
#
# Single container with TimescaleDB, Redis, and Tracearr bundled together.
# Secrets are auto-generated on first run â€” no configuration required.
#
# REQUIREMENTS:
#   - Minimum 2GB RAM (container runs PostgreSQL + Redis + Node.js)
#   - Containers with less memory will crash with exit code 137 (OOM killed)
#
# DEPLOY:
#   docker compose -f docker/docker-compose.supervised.yml up -d
#
# Data is stored in Docker volumes by default.
# For bind mounts, uncomment the volumes section below.

services:
  tracearr:
    image: ghcr.io/connorgallopo/tracearr:supervised
    shm_size: 256mb  # Required for PostgreSQL shared memory
    mem_limit: 2g    # Minimum 2GB required (PostgreSQL + Redis + Node.js)
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - TZ=${TZ:-UTC}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # - DATABASE_POOL_MAX=50  # Database connection pool size (default: 50)
      # Optional: Override auto-generated secrets
      # - JWT_SECRET=${JWT_SECRET}
      # - COOKIE_SECRET=${COOKIE_SECRET}
    volumes:
      - tracearr_postgres:/data/postgres
      - tracearr_redis:/data/redis
      - tracearr_data:/data/tracearr
      # Bind mount alternative (uncomment and adjust paths):
      # - ./data/postgres:/data/postgres
      # - ./data/redis:/data/redis
      # - ./data/tracearr:/data/tracearr
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:3000/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

volumes:
  tracearr_postgres:
  tracearr_redis:
  tracearr_data:
